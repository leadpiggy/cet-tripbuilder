{% extends "base.html" %}

{% block title %}{% if trip %}Edit Trip{% else %}Create Trip{% endif %} - TripBuilder{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <h1><i class="bi bi-map"></i> {% if trip %}Edit Trip{% else %}Create New Trip{% endif %}</h1>
        <p class="text-muted">{% if trip %}Update trip details{% else %}Enter trip information{% endif %}</p>
        
        <div class="card">
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="destination" class="form-label">Destination <span class="text-danger">*</span></label>
                        <input type="text" 
                               class="form-control" 
                               id="destination" 
                               name="destination" 
                               value="{{ trip.destination if trip else '' }}"
                               required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="start_date" class="form-label">Start Date <span class="text-danger">*</span></label>
                            <input type="date" 
                                   class="form-control" 
                                   id="start_date" 
                                   name="start_date" 
                                   value="{{ trip.start_date.strftime('%Y-%m-%d') if trip else '' }}"
                                   required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="end_date" class="form-label">End Date <span class="text-danger">*</span></label>
                            <input type="date" 
                                   class="form-control" 
                                   id="end_date" 
                                   name="end_date" 
                                   value="{{ trip.end_date.strftime('%Y-%m-%d') if trip else '' }}"
                                   required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="max_capacity" class="form-label">Max Capacity <span class="text-danger">*</span></label>
                        <input type="number" 
                               class="form-control" 
                               id="max_capacity" 
                               name="max_capacity" 
                               value="{{ trip.max_capacity if trip else 10 }}"
                               min="1"
                               required>
                        <small class="form-text text-muted">Maximum number of passengers for this trip</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="trip_vendor_id" class="form-label">Trip Vendor</label>
                        <select class="form-select" id="trip_vendor_id" name="trip_vendor_id">
                            <option value="">None (no vendor assigned)</option>
                            <option value="create_new" class="text-primary fw-bold">+ Create New Vendor...</option>
                            {% for vendor in all_vendors %}
                            <option value="{{ vendor.id }}"
                                    {% if trip and trip.trip_vendor_id == vendor.id %}selected{% endif %}>
                                {{ vendor.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            Select a vendor or <a href="{{ url_for('vendor_list') }}" target="_blank">manage vendors</a>
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" 
                                  id="notes" 
                                  name="notes" 
                                  rows="4"
                                  placeholder="Additional trip details, itinerary, requirements, etc.">{{ trip.notes if trip else '' }}</textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('trip_list') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> {% if trip %}Update Trip{% else %}Create Trip{% endif %}
                        </button>
                    </div>
                </form>
            </div>

<!-- Vendor Creation Modal -->
<div class="modal fade" id="createVendorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="vendorCreateForm">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Vendor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modal_vendor_name" class="form-label">Vendor Name <span class="text-danger">*</span></label>
                        <input type="text" 
                               class="form-control" 
                               id="modal_vendor_name" 
                               name="name" 
                               required
                               placeholder="e.g., Cuba Travel Services">
                    </div>
                    <div class="mb-3">
                        <label for="modal_vendor_description" class="form-label">Description</label>
                        <textarea class="form-control" 
                                  id="modal_vendor_description" 
                                  name="description" 
                                  rows="3"
                                  placeholder="Optional: Contact info, specialties, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Create Vendor
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const vendorSelect = document.getElementById('trip_vendor_id');
    const createVendorModal = new bootstrap.Modal(document.getElementById('createVendorModal'));
    const vendorForm = document.getElementById('vendorCreateForm');
    
    // Handle vendor dropdown change
    vendorSelect.addEventListener('change', function() {
        if (this.value === 'create_new') {
            // Show modal
            createVendorModal.show();
            // Reset dropdown to empty
            this.value = '';
        }
    });
    
    // Handle vendor creation form submission
    vendorForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(this);
        
        // Send AJAX request
        fetch('{{ url_for("api_vendor_create") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new vendor to dropdown
                const option = document.createElement('option');
                option.value = data.id;
                option.text = data.name;
                option.selected = true;
                
                // Insert before "Create New" option
                const createNewOption = vendorSelect.querySelector('option[value="create_new"]');
                vendorSelect.insertBefore(option, createNewOption);
                
                // Close modal and reset form
                createVendorModal.hide();
                vendorForm.reset();
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="bi bi-check-circle"></i> Vendor "${data.name}" created successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.card-body').prepend(alertDiv);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            } else {
                alert('Error creating vendor: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating vendor. Please try again.');
        });
    });
});
</script>

        </div>
        
        {% if trip %}
        <div class="card mt-3 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Danger Zone</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Deleting this trip will also remove all passenger enrollments. This action cannot be undone.</p>
                <form method="POST" action="{{ url_for('trip_delete', trip_id=trip.id) }}" onsubmit="return confirm('Are you sure you want to delete this trip? All passenger enrollments will be removed.');">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete Trip
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
